{{- /* +x */ -}}
#!/usr/bin/env bash

LOCATION="waw"
CACHE_DIR="$HOME/.config/sketchybar/cache"
CACHE_FILE="$CACHE_DIR/weather_T.txt"
CACHE_DURATION=1800  # 30 minutes

mkdir -p "$CACHE_DIR"

fetch_T() {
  curl -s --max-time 10 "wttr.in/${LOCATION}?T" -o "$CACHE_FILE"
}

load_T() {
  if [[ -f "$CACHE_FILE" ]]; then
    mod=$(stat -f %m "$CACHE_FILE" 2>/dev/null || stat -c %Y "$CACHE_FILE")
    age=$(( $(date +%s) - mod ))
    (( age < CACHE_DURATION )) && return
  fi
  fetch_T
}

MODE="${1:-both}"
load_T

# Read the two tokens: ICON and TEMP
read -r ICON TEMP < "$CACHE_FILE"

if [[ -n "$ICON" && -n "$TEMP" ]]; then
  case "$MODE" in
    icon) sketchybar --set weather.icon icon="$ICON" ;;
    temp) sketchybar --set weather.temp label="$TEMP" ;;
    *)    sketchybar --set weather.icon icon="$ICON" \
                     --set weather.temp label="$TEMP" ;;
  esac
else
  case "$MODE" in
    icon) sketchybar --set weather.icon icon="❓" ;;
    temp) sketchybar --set weather.temp label="--" ;;
    *)    sketchybar --set weather.icon icon="❓" \
                     --set weather.temp label="--" ;;
  esac
fi

