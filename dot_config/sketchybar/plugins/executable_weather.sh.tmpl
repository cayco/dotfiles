{{- /* +x */ -}}
#!/usr/bin/env bash

# Configuration
LOCATION="{{ .chezmoi.hostname }}"   # replace with fixed name if you prefer
CACHE_DIR="$HOME/.config/sketchybar/cache"
CACHE_FILE="$CACHE_DIR/weather_cache.html"
CACHE_DURATION=1800   # 30 minutes

# Ensure cache directory exists
mkdir -p "$CACHE_DIR"

# Fetch HTML if cache expired or missing
fetch_html() {
  local url="https://wttr.in/${LOCATION}?m&lang=en"
  if curl -s --max-time 10 "$url" -o "$CACHE_FILE"; then
    return 0
  else
    return 1
  fi
}

# Load HTML (fresh or cached)
load_html() {
  if [[ -f "$CACHE_FILE" ]]; then
    local modified=$(stat -f %m "$CACHE_FILE" 2>/dev/null || stat -c %Y "$CACHE_FILE")
    local age=$(( $(date +%s) - modified ))
    if (( age < CACHE_DURATION )); then
      return 0
    fi
  fi
  fetch_html || return 0
}

# Parse temperature (e.g. “+23°C” or “–02°C”)
parse_temp() {
  grep -oP '(?<=<span class="temp">)[^<]+' "$CACHE_FILE" | head -1
}

# Parse icon description and map to Unicode
parse_icon() {
  local desc
  desc=$(grep -oP '(?<=<span class="weather-icon" title=")[^"]+' "$CACHE_FILE" | head -1)
  case "$desc" in
    *Sunny*|*Clear*)       echo "☀️" ;;
    *Partly*|*Cloudy*)     echo "⛅" ;;
    *Overcast*|*Clouds*)   echo "☁️" ;;
    *Mist*|*Fog*)          echo "🌫️" ;;
    *Drizzle*|*Rain*|*Showers*) echo "🌧️" ;;
    *Thunder*|*Storm* )    echo "⛈️" ;;
    *Snow*|*Sleet* )       echo "❄️" ;;
    *)                      echo "🌤️" ;;
  esac
}

# Main
MODE="${1:-both}"
load_html || true

TEMP=$(parse_temp)
ICON=$(parse_icon)

if [[ -n "$TEMP" && -n "$ICON" ]]; then
  case "$MODE" in
    icon) sketchybar --set weather.icon icon="$ICON" ;;
    temp) sketchybar --set weather.temp label="$TEMP" ;;
    *)    sketchybar --set weather.icon icon="$ICON" \
                     --set weather.temp label="$TEMP" ;;
  esac
else
  # Fallback
  case "$MODE" in
    icon) sketchybar --set weather.icon icon="❓" ;;
    temp) sketchybar --set weather.temp label="--" ;;
    *)    sketchybar --set weather.icon icon="❓" \
                     --set weather.temp label="--" ;;
  esac
fi

